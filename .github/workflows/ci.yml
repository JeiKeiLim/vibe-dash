name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Environment variables for TUI test determinism (Story 9.2 AC4, Story 9.6 AC7)
# =============================================================================
# NO_COLOR=1      - Disables ANSI colors in lipgloss/termenv for golden file consistency
# FORCE_COLOR=0   - Prevents color forcing in environments that might override NO_COLOR
# TERM=dumb       - Disables terminal capability detection to ensure consistent rendering
#
# These variables ensure golden file tests produce identical output across:
# - Local development (macOS, Linux)
# - CI environments (GitHub Actions)
# - Different terminal emulators
#
# See also: internal/adapters/tui/teatest_helpers_test.go - calls lipgloss.SetColorProfile(termenv.Ascii)
env:
  NO_COLOR: 1
  FORCE_COLOR: 0
  TERM: dumb

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install goimports
        run: go install golang.org/x/tools/cmd/goimports@latest

      - name: Check formatting
        run: make check-fmt

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  unit-tests:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run unit tests
        run: make test

  integration-tests:
    runs-on: macos-latest  # Required for /dev/fd FD counting (Story 9.5)
    needs: [lint]
    timeout-minutes: 15  # Buffer for setup + 10m test timeout (Story 9.5 AC3)
    env:
      CGO_ENABLED: 1  # Required for go-sqlite3 on macOS
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run integration tests
        run: make test-all

  build:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build
        run: make build
