# Epic 15 Retrospective - Sub-1-Minute Agent Detection

**Date:** 2026-01-16
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Jongkuk Lim (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| **Epic** | Epic 15: Sub-1-Minute Agent Detection |
| **Goal** | Parse Claude Code JSONL logs for instant agent state detection (THE killer feature) |
| **Stories Completed** | 7/7 (100%) |
| **Phase** | Phase 2 (Active Collaboration Partner) |
| **Epic Status** | `in-progress` (pending bug fix) |

### Stories Delivered

| Story | Title | Key Achievement |
|-------|-------|-----------------|
| 15-1 | Define AgentActivityDetector Interface | Foundation types (AgentState, AgentStatus) following existing patterns |
| 15-2 | Claude Code Project Path Matcher | Cache with symlink normalization, thread-safe |
| 15-3 | JSONL Log Parser | Tail-optimized: 118Î¼s for 10K entries |
| 15-4 | Agent State Detection Logic | ClaudeCodeDetector with stop_reason handling |
| 15-5 | Generic File-Activity Fallback | 10-minute threshold fallback detector |
| 15-6 | TUI Dashboard Integration | Replaced old WaitingDetector architecture |
| 15-7 | Confidence Level Display | "High/Low confidence" in detail panel |

### Technical Metrics

| Metric | Value |
|--------|-------|
| Tests Added | +102 (1194 â†’ 1296) |
| Performance | 118Î¼s for 10K log entries (NFR target: < 1 second) |
| Code Reviews | 7/7 stories reviewed with fixes applied |

---

## Previous Retrospective Follow-Up (Epic 11)

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| C1 | Verify CI runs integration tests | â³ **Carry-forward (3x)** | Now prioritized as HIGH |
| P1 | Add integration tests for state persistence | â³ Backlog | Not addressed |

**Result:** 0/2 action items completed. Both carried forward with elevated priority.

---

## What Went Well

### 1. Interface-First Design
- `AgentActivityDetector` interface defined in Story 15.1
- Followed existing patterns from `Confidence` and `Stage` types
- Clean separation enabled modular implementation

### 2. Performance Optimization
- Tail-optimized JSONL reading (Story 15.3)
- 118Î¼s for 10,000 entries vs 1-second NFR target
- Read backwards from EOF in 32KB chunks

### 3. Modular Architecture
- PathMatcher â†’ LogParser â†’ Detector â†’ Service â†’ Adapter
- Each component independently testable
- Enables targeted debugging

### 4. Comprehensive Testing
- 102 new tests across 7 stories
- Table-driven test patterns
- All code reviews passed with fixes applied

### 5. Fallback Design
- Claude Code detection with Generic fallback
- Confidence levels distinguish log-based vs heuristic detection
- Graceful degradation for non-Claude projects

---

## What Didn't Go Well

### 1. Detection Not Working in Production
- Real-world testing during retrospective revealed issues
- Unit tests passed but integration failed
- See "Critical Issues Discovered" section

### 2. Integration Tests Repeatedly Deprioritized
- C1 carried forward 3 times from previous retros
- Would have caught detection issues in CI
- Now elevated to HIGH priority

### 3. Story 15.3 Memory Bug
- O(nÂ²) memory allocation in backward reading
- Caught in code review, not unit tests
- Fixed: collect reversed, reverse once at end

### 4. Multiple Context Cancellation Fixes
- Story 15.4 needed checks between each step
- Initial implementation only checked at entry
- Pattern now documented for future stories

---

## Critical Issues Discovered

### RETRO-15-001: Agent Detection Not Working Correctly

**Discovered During:** Retrospective real-world testing

| # | Project | Expected State | Actual State | Problem |
|---|---------|---------------|--------------|---------|
| 1 | claude-code-log-viewer | WAITING (session finished) | "1m ago" only | Not detecting WAITING |
| 2 | vibe-dash | WORKING (active session) | "WAITING 11m" | Showing WAITING when should be WORKING |

**Severity:** HIGH - Core feature not working

**Possible Root Causes:**
1. `FindMostRecentSession()` not finding active session
2. Path matching pointing to wrong session file
3. Log parsing reading stale data
4. Session file mtime not updating as expected

**Impact:** Epic 15 cannot be marked `done` until resolved

---

## Action Items

### Critical Path (Blocking)

| # | Action Item | Owner | Priority | Status |
|---|-------------|-------|----------|--------|
| C1 | **Investigate WAITING detection bug** (RETRO-15-001) | Dev | ðŸ”´ HIGH | New |
| C2 | **Verify CI runs integration tests** | Dev | ðŸ”´ HIGH | Carry-forward (3x) |

### Process Improvements

| # | Action Item | Owner | Priority | Status |
|---|-------------|-------|----------|--------|
| P1 | Add integration tests for agent detection flow | Dev | HIGH | New |
| P2 | Add integration tests for state persistence | Dev | MEDIUM | Carry-forward |

### Follow-Up Required

- **Create bug fix story** after C1 investigation identifies root cause
- **Do not start Epic 16** until detection is verified working

---

## Lessons Learned

1. **Unit tests are not enough** - All 1296 tests passed, but real-world usage immediately found issues

2. **Integration tests catch integration bugs** - The detection pipeline (PathMatcher â†’ LogParser â†’ Detector) works in isolation but fails when integrated

3. **Dogfooding is essential** - Using vibe-dash on active Claude Code projects exposed problems that automated tests missed

4. **Carry-forward items compound** - C1 (integration tests) carried forward 3 times; if addressed earlier, would have caught these issues

5. **Modular design aids debugging** - The clean separation between components makes it easier to isolate the bug

---

## Epic Status Decision

| Decision | Value |
|----------|-------|
| **Epic 15 Status** | `in-progress` (not done) |
| **Reason** | Core detection feature not working correctly |
| **Blocker** | RETRO-15-001 must be resolved |
| **Next Steps** | Investigate bug, create fix story, verify detection works |

---

## Dependency Check

User noted Epics 13 and 14 were skipped. Verified no dependency issues:

| Epic | Focus | Dependency on Epic 15? |
|------|-------|------------------------|
| Epic 13 | Dynamic Binary Name Polish | âŒ None - cosmetic |
| Epic 14 | Methodology Switching Detection | âŒ None - separate system |
| Epic 15 | Agent Detection | âœ… Independent |

**Conclusion:** Epics can be completed in any order.

---

## Next Epic Preparation

### Epic 16: Progress Metrics & Stats View

**Status:** Blocked until Epic 15 detection bug is fixed

**Rationale:** No point tracking agent state transitions if we can't detect agent state correctly.

**Prerequisites:**
1. Resolve RETRO-15-001 (detection bug)
2. Verify detection works on real Claude Code projects
3. Add integration tests (P1)

---

## Retrospective Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 7/7 (100%) |
| Stories Added Mid-Epic | 0 |
| Previous Action Items Resolved | 0/2 |
| New Action Items | 4 (2 critical, 2 process) |
| Critical Issues Discovered | 1 (RETRO-15-001) |
| Epic Marked Done | âŒ No (pending bug fix) |

---

*Retrospective facilitated by Bob (Scrum Master)*
*Document generated: 2026-01-16*
