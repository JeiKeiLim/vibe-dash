# Epic 9 Retrospective - TUI Behavioral Testing Infrastructure

**Date:** 2026-01-01
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Jongkuk Lim (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| **Epic** | Epic 9: TUI Behavioral Testing Infrastructure |
| **Goal** | Create automated testing infrastructure to catch visual/behavioral bugs |
| **Stories Completed** | 6/6 (100%) |
| **Origin** | Epic 8 retrospective action item C1 |
| **Key Insight** | "Automated TUI testing prevents the 20-iteration debugging cycle from Story 8-12" |

### Stories Delivered

| Story | Title | Key Achievement |
|-------|-------|-----------------|
| 9-1 | TUI Testing Tools Research | Chose teatest + custom resource monitor hybrid approach |
| 9-2 | Terminal Size Simulation Framework | Helpers, presets, golden file infrastructure established |
| 9-3 | Anchor Point Stability Tests | 11 tests, 4 golden files for navigation stability |
| 9-4 | Layout Consistency Tests | 24 tests, 6 golden files for layout regression detection |
| 9-5 | Long-Running Session Tests | goleak integration, FD monitoring for resource leaks |
| 9-6 | CI Pipeline Integration | Parallel jobs, macOS runner for reliable FD testing |

**Testing Infrastructure Created:**
- 35 behavioral tests total (11 anchor + 24 layout)
- 10 golden files for visual regression detection
- goleak + custom FD monitoring for resource leak detection
- CI pipeline with parallel unit/integration jobs

---

## Previous Retrospective Follow-Up (Epic 8)

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| C1 | Create Epic 9: TUI Behavioral Testing Infrastructure | ✅ **Done** | Epic completed with 6 stories |
| C2 | Renumber Epic 5 → Epic 11 | ✅ **Done** | Updated in sprint-status.yaml |
| C3 | Renumber Epic 9 → Epic 10 | ✅ **Done** | Scalable Watching now Epic 10 |
| P1 | Pipeline summary output after completion | ❌ Not addressed | Carried forward to Epic 9.5 |
| P2 | "User-Visible Changes" section in stories | ❌ Not addressed | Carried forward to Epic 9.5 |
| P3 | Structured observation handoff for visual changes | ❌ Not addressed | Carried forward to Epic 9.5 |

**Result:** 3/6 action items completed (all critical path items). Process improvements carried forward to Epic 9.5.

---

## What Went Well

### 1. Research-First Approach Paid Off
- Story 9.1 research led to clear technology choice (teatest over VHS)
- Hybrid approach (teatest + custom resource monitor) covers all use cases
- No pivots or rework needed during implementation

### 2. Comprehensive Test Coverage
- 35 behavioral tests created across Stories 9.3 and 9.4
- 10 golden files for visual regression detection
- Long-running session tests catch resource leaks automatically

### 3. Clean Epic Execution
- No major blockers or scope changes
- All 6 stories completed as planned
- Testing infrastructure ready for future development

### 4. CI Pipeline Improvements
- Parallel job execution (lint → unit/integration → build)
- macOS runner for reliable FD testing
- Faster feedback on pull requests

---

## What Didn't Go Well

### 1. Pre-existing Test Failures
- Resize simulation tests and some integration tests failing
- Not introduced by Epic 9, but discovered during validation
- Need cleanup in Epic 9.5

### 2. File Watcher Instability Discovered
- After Story 8-13 fix, new issues emerged:
  - Rapid retry/refreshing behavior (looks like blinking)
  - "File watching unavailable" warning appearing
- Story 8-13 fixed FD leak but exposed underlying stability issues

### 3. External Dependency Change
- BMAD Method changed directory structure from `.bmad` to `_bmad`
- Detector needs update to support new structure

---

## New Issues Identified

### File Watcher Instability (User Reported)
**Symptoms:**
- Rapid retrying for refreshing (looks like blinking)
- "File watching unavailable" warning appearing intermittently
- FD leak fixed in 8-13, but watcher still unstable

**Root Cause:** Unknown - needs investigation in Epic 9.5

### BMAD Directory Structure Change
**Change:** BMAD Method v6 updated directory from `.bmad` to `_bmad`
**Impact:** Current detector only checks `.bmad` path
**Fix:** Update detector to check both paths (backward compatibility)

### Stage Detection for Backlog Epics (User Reported)
**Symptom:** Dashboard shows "Unknown" stage when next epic is in backlog
**Example:** Epic 9 done, Epic 9.5 in backlog → should show "Epic 9.5 / Story 9.5-1"
**Root Cause:** Stage detection logic doesn't recognize backlog epics as valid next stage

---

## Epic 9.5: Stability & BMAD Update (NEW)

Created as pre-post-MVP gate to address accumulated issues.

| Story | Title | Priority | Notes |
|-------|-------|----------|-------|
| 9.5-1 | File Watcher Stability Investigation | High | Diagnose rapid retry/blinking behavior |
| 9.5-2 | File Watcher Error Handling | High | Fix "File watching unavailable" warnings |
| 9.5-3 | BMAD Directory Structure Update | High | Support `_bmad` alongside `.bmad` |
| 9.5-4 | Pre-existing Test Failures Cleanup | Medium | Fix resize simulation, integration tests |
| 9.5-5 | Pipeline Summary Output | Low | P1 carried forward (4th time) |
| 9.5-6 | User-Visible Changes Section | Low | P2 carried forward (4th time) |
| 9.5-7 | Stage Detection for Backlog Epics | Medium | Shows "Unknown" instead of next epic/story |

**Note:** Epic 9.5 scope may grow as additional issues are discovered during implementation.

---

## Action Items

### Critical Path (Before Post-MVP)

| # | Action Item | Owner | Notes |
|---|-------------|-------|-------|
| C1 | Create Epic 9.5 in sprint-status.yaml | SM | Add 6 stories as defined above |
| C2 | Investigate file watcher stability | Dev | Stories 9.5-1 and 9.5-2 |
| C3 | Research BMAD v6 directory changes | Dev | Story 9.5-3 |

### Process Improvements (Carried Forward)

| # | Action Item | Owner | Status |
|---|-------------|-------|--------|
| P1 | Pipeline summary output after completion | Dev Team | Carried forward (4th time) - Story 9.5-5 |
| P2 | "User-Visible Changes" section in stories | SM | Carried forward (4th time) - Story 9.5-6 |
| P3 | Structured observation handoff | SM | Carried forward - deprioritized |

---

## Lessons Learned

1. **Infrastructure epics can be clean executions** - Research-first approach (Story 9.1) led to clear implementation path with no pivots.

2. **Fixes can reveal deeper issues** - Story 8-13 fixed the FD leak but exposed underlying watcher instability. Surface-level fixes may not address root causes.

3. **External dependencies change** - BMAD Method updated directory structure. Need to monitor upstream changes and maintain backward compatibility.

4. **Process improvements keep deferring** - P1/P2 carried forward 4 times now. Consolidated into Epic 9.5 stories to force resolution.

5. **Testing infrastructure enables confidence** - 35 behavioral tests + 10 golden files now protect against layout regressions that previously required 20+ iterations to debug.

---

## Retrospective Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 6/6 (100%) |
| Stories Added Mid-Epic | 0 |
| Previous Action Items Resolved | 3/6 (critical path items) |
| New Action Items Created | 3 critical + 3 process |
| New Epic Created | Epic 9.5: Stability & BMAD Update |
| Behavioral Tests Created | 35 (11 anchor + 24 layout) |
| Golden Files Created | 10 |

---

## Epic Sequence Update

| Epic | Name | Status |
|------|------|--------|
| 1-8 | MVP Epics | Done |
| 9 | TUI Behavioral Testing Infrastructure | **Done** |
| **9.5** | **Stability & BMAD Update** | **NEW - Pre-post-MVP** |
| 10 | Scalable File Watching | Post-MVP (backlog) |
| 11 | Project Hibernation | Post-MVP (backlog) |

**Next Phase:** Epic 9.5 must complete before post-MVP feature work (Epic 10, 11).

---

*Retrospective facilitated by Bob (Scrum Master)*
*Document generated: 2026-01-01*
