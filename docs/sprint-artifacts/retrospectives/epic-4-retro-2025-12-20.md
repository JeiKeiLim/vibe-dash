# Epic 4 Retrospective - Agent Waiting Detection (Killer Feature)

**Date:** 2025-12-20
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Jongkuk Lim (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| **Epic** | Epic 4: Agent Waiting Detection |
| **Goal** | Implement the killer feature - detecting when AI coding agents are waiting for user input |
| **Stories Completed** | 6 of 6 (100%) |
| **Status** | All stories done, but end-to-end gaps identified |

### Stories Delivered

| Story | Title | Status | Key Achievement |
|-------|-------|--------|-----------------|
| 4.1 | File Watcher Service | done | FsnotifyWatcher with 200ms debounce, 19+ tests |
| 4.2 | Activity Timestamp Tracking | done | ActivityTracker service, O(1) project ID cache |
| 4.3 | Agent Waiting Detection Logic | done | Stateless WaitingDetector, boundary precision |
| 4.4 | Waiting Threshold Configuration | done | CLI > project > global cascade, config command |
| 4.5 | Waiting Indicator Display | done | Callback pattern for components, interface in ports |
| 4.6 | Real-Time Dashboard Updates | done | FileWatcher TUI integration, smooth re-render |

### Code Review Findings (Fixed)

- Story 4.1: Fixed race condition in flushPending
- Story 4.2: Added O(1) projectID cache to coordinator
- Story 4.3: Added negative duration clamping (defensive)
- Story 4.4: Replaced custom itoa with strconv.Itoa
- Story 4.5: Added integration tests for wiring
- Story 4.6: Verified all ACs after macOS crash

---

## What Went Well

1. **Solid Hexagonal Architecture**
   - Interface-based dependency injection (`ports.WaitingDetector`, `ports.ThresholdResolver`)
   - Callback pattern for TUI components (avoiding import cycles)
   - Stateless detector design (thread-safe, testable)

2. **Effective Code Reviews**
   - Race condition caught in FileWatcher (Story 4.1)
   - O(1) cache optimization added (Story 4.2)
   - Defensive programming improvements (Story 4.3)

3. **Thorough Documentation**
   - Each story has complete Dev Agent Record
   - Completion notes document decisions made
   - File lists track all changes

4. **Technical Quality**
   - Comprehensive test coverage
   - Boundary tests (9m59s vs 10m01s)
   - Edge case handling (nil project, hibernated, threshold=0)

---

## What Didn't Go Well

### Critical Finding: End-to-End Gap (Same Pattern as Epic 3.5)

**User Feedback from Jongkuk Lim:**
> "After epic 4, I'm not sure if this feature is actually implemented. I saw all of you did hard work but I can't seem to find how to notice this feature. I turned on vibe dashboard and there is no agent waiting or agent is working kind of display there."

**Root Cause Analysis:**

| Issue | Description | Impact |
|-------|-------------|--------|
| **No UX indication** | Status bar hides WAITING section when count=0 (per AC5 in Story 4.5) | User can't tell feature exists |
| **Bootstrapping logic** | WaitingDetector returns false when `last_activity_at == created_at` | New projects never show WAITING |
| **Activity not updating** | `last_activity_at` hasn't changed since project add | FileWatcher events not recorded |

**Evidence:**
```sql
-- Both tracked projects have identical timestamps
vibe-dash  | last_activity_at = created_at | same=1
promptory  | last_activity_at = created_at | same=1
```

**Feature Requires Specific Sequence:**
1. Run the TUI dashboard (starts FileWatcher)
2. FileWatcher observes at least ONE file change
3. Wait 10+ minutes of inactivity
4. ONLY THEN does WAITING indicator appear

This sequence is not documented and not obvious to users.

### Additional Finding: Speckit Detector Bug (Epic 2)

**User Feedback:**
> "I checked on my another project using speckit and it says I'm on spec 001 which is not true. I'm on 005 spec."

**Root Cause:**
- Detector uses directory modification time to find "most recent" spec
- Git clone sets all directories to same timestamp
- When mtimes are equal, sort is unstable and picks unpredictably
- Result: 001 selected instead of 005

**Evidence:**
```
001-fix-modal-autoclose    12Ïõî  5 07:53:38 2025
002-tag-search-highlight   12Ïõî  5 07:53:38 2025
003-llm-integration        12Ïõî  5 07:53:38 2025
004-llm-response-titles    12Ïõî  5 07:53:38 2025
005-ui-ux-polish           12Ïõî  5 07:53:38 2025
```

All directories have identical timestamps due to git clone.

---

## Previous Retrospective Follow-Up (Epic 3.5)

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| 1 | Epic Acceptance Test | Partial | No formal test added; gap recurred |
| 2 | Single Source of Truth | Complete | All commands use injected repository |
| 3 | Automated Smoke Test | Partial | Integration tests exist, no binary smoke test |
| 4 | Shared test helpers package | Deferred | Not addressed in Epic 4 |
| 5 | Shared styles package | Deferred | Style duplication noted in Story 4.5 |

**Pattern:** We committed to end-to-end verification but didn't follow through, and the same gap recurred.

---

## Action Items

### High Priority (Address Before Epic 5)

| # | Action Item | Owner | Rationale |
|---|-------------|-------|-----------|
| H1 | **Show WAITING count even when 0** | Dev Team | Modify AC5 in Story 4.5 - show `0 waiting` or similar so users know feature exists |
| H2 | **Epic Acceptance Test process** | SM + QA | Before marking epic "done", run end-to-end user scenario. Create checklist. |
| H3 | **Verify FileWatcher updates activity** | Dev Team | Confirm `last_activity_at` actually updates when files change while TUI is open |
| H4 | **Fix Speckit detector tiebreaker** | Dev Team | When mtimes equal, use lexicographic sort descending (highest number wins) |

### Medium Priority (Address in Epic 5 or 6)

| # | Action Item | Owner | Rationale |
|---|-------------|-------|-----------|
| M1 | **Reconsider bootstrapping logic** | Product + Dev | Should projects show WAITING after threshold even if no activity observed? |
| M2 | **Shared test helpers package** | Dev Team | Carried from Epic 3 -> 3.5 -> 4. Create `internal/testutil/` |
| M3 | **Shared styles package** | Dev Team | Style duplication in delegate, status_bar, detail_panel needs consolidation |

### Low Priority (Backlog)

| # | Action Item | Owner | Rationale |
|---|-------------|-------|-----------|
| L1 | **Detail panel horizontal layout option** | UX + Dev | User request: top/bottom split instead of left/right |
| L2 | **Package godoc documentation** | Dev Team | Missing package-level documentation |

---

## Lessons Learned

1. **"Done" stories != working feature** - All 6 stories passed code review and tests, but the user couldn't experience the feature. We need epic-level acceptance testing.

2. **UX visibility matters** - Hiding UI elements when count=0 (AC5) seemed reasonable in isolation, but means users never discover the feature exists.

3. **Bootstrapping logic creates chicken-and-egg problems** - The "no activity observed yet" check prevents false positives but also prevents feature discovery.

4. **Git operations affect detection heuristics** - Relying on filesystem timestamps is fragile; git clone/checkout resets them.

5. **Carry-forward items need accountability** - M2/M3 have been carried for 3 epics without progress. Need to either do them or explicitly de-prioritize.

---

## Next Epic Preview: Epic 5 (Hibernation)

Epic 5 builds directly on Epic 4:
- Auto-activation uses FileWatcher (Story 4.1)
- Hibernation threshold uses activity timestamps (Story 4.2)
- WaitingDetector excludes hibernated projects (Story 4.3)

**Risk:** If H1-H4 aren't addressed, Epic 5 may have similar end-to-end gaps.

**Recommendation:** Address H1-H4 before starting Epic 5 stories.

---

## Retrospective Metrics

| Metric | Value |
|--------|-------|
| Issues Identified | 6 |
| Action Items Created | 9 |
| High Priority Items | 4 |
| Carried Forward from Previous | 3 (M2, M3, H2) |
| User Feedback Items | 2 (WAITING visibility, detail panel layout) |

---

## Post-Session Findings (Added after hotfix verification)

During manual verification of the hotfixes, additional issues were discovered:

### Bug: WAITING State Not Updating on Tick

**Symptom:** User ran `./bin/vibe --waiting-threshold=1`, waited 5+ minutes, but WAITING indicator never appeared.

**Evidence:**
- Database shows `last_activity_at` = 06:03:25, current time = 06:11:50 (8+ minutes)
- Threshold set to 1 minute via CLI flag
- Status bar still shows "0 waiting"

**Root Cause (Suspected):**
The `tickMsg` handler doesn't recalculate status bar waiting counts:
```go
case tickMsg:
    return m, tickCmd()  // Missing: recalculate waiting counts!
```

Status bar counts are only recalculated on:
- `ProjectsLoadedMsg`
- `ProjectRemovedMsg`
- `FileEventMsg`

But NOT on `tickMsg`, so waiting state doesn't update periodically.

**Priority:** High - Core feature doesn't work as expected

**File:** `internal/adapters/tui/model.go` (tickMsg handler)

**Resolution:** Fixed - Added `components.CalculateCountsWithWaiting()` call in tickMsg handler to recalculate waiting counts on each tick.

---

### User Feedback Items

| # | Feedback | Type | Description |
|---|----------|------|-------------|
| F1 | Show agent working/waiting state clearly | Enhancement | User expected to see working/waiting on each project row. Feature exists but may have bugs preventing display. |
| F2 | Show current configuration in TUI | New Feature | Display current threshold and other config values in TUI (e.g., in status bar or help overlay) |
| F3 | Detail panel horizontal layout | Enhancement | User prefers top/bottom split over left/right (already captured as L1) |

---

### Updated Action Items

| Priority | # | Item | Owner | Status |
|----------|---|------|-------|--------|
| üü¢ Done | H5 | **Fix tickMsg to recalculate waiting counts** | Dev | Fixed |
| üü° Med | F2 | **Show config in TUI** | Dev | New - Enhancement |

---

### Hotfix Verification Results

| Fix | Verified | Notes |
|-----|----------|-------|
| H1: "0 waiting" visible | ‚úÖ Yes | User confirmed seeing "0 waiting" |
| H4: Speckit 005-* selected | ‚úÖ Yes | User confirmed seeing correct spec |
| H3: FileWatcher working | ‚ö†Ô∏è Partial | Timestamps update, but WAITING state has separate bug |

---

*Retrospective facilitated by Bob (Scrum Master)*
*Document generated: 2025-12-20*
*Post-session findings added: 2025-12-20*
