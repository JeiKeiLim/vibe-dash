# Epic 14 Retrospective - Methodology Switching Detection

**Date:** 2026-01-16
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Amelia (Dev), Winston (Architect), Dana (QA Engineer), Jongkuk Lim (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| **Epic** | Epic 14: Methodology Switching Detection |
| **Goal** | Fix first-match-wins bug with most-recent-artifact-wins selection |
| **Stories Completed** | 5/5 (100%) |
| **Phase** | Phase 2 (Active Collaboration Partner) |
| **Epic Status** | `done` |

### Stories Delivered

| Story | Title | Key Achievement |
|-------|-------|-----------------|
| 14-1 | DetectWithCoexistence Registry Method | Runs ALL detectors (not first-match-wins) |
| 14-2 | Add Artifact Timestamp to Detection Results | Tracks mtime for both Speckit and BMAD |
| 14-3 | Most-Recent-Artifact-Wins Selection | SelectByTimestamp in domain layer |
| 14-4 | Coexistence Warning for Tie-Breaker | CoexistenceWarning flag when <1hr diff |
| 14-5 | TUI Coexistence Display | Warning emoji and detail panel message |

### Technical Metrics

| Metric | Value |
|--------|-------|
| Tests Added | +38 (1302 → 1340) |
| Code Reviews | 5/5 stories reviewed with fixes applied |
| Code Review Fixes | 10 total (1 High, 9 Medium/Low) |

### FR Coverage

| FR ID | Description | Story |
|-------|-------------|-------|
| FR-P2-7 | Run all detectors | 14-1 |
| FR-P2-8 | Track artifact timestamps | 14-2 |
| FR-P2-9 | Select based on most recent artifact | 14-3 |
| FR-P2-10 | Display coexistence warning | 14-4 |
| FR-P2-11 | Display both methodologies on tie | 14-5 |

---

## Previous Retrospective Follow-Up (Epic 13)

| # | Action Item | Status | Notes |
|---|-------------|--------|-------|
| - | (None) | - | Epic 13 had clean execution with no action items |

**Result:** Epic 13 validated that well-specified quick win epics excel with full automation.

---

## What Went Well

### 1. Hexagonal Architecture Boundaries Respected
- Story 14.3 placed `SelectByTimestamp` in domain layer, not adapters
- Domain owns selection logic, service orchestrates
- No boundary violations across all 5 stories

### 2. Incremental Story Structure
- Each story built cleanly on the previous:
  1. Run all detectors (14.1)
  2. Add timestamps (14.2)
  3. Select by timestamp (14.3)
  4. Add warning flag (14.4)
  5. Display in TUI (14.5)
- No story blocked waiting for another

### 3. Code Review Caught Real Bugs
- **Story 14.5 H1:** UTF-8 truncation bug (byte slicing on rune strings)
- **Story 14.5 M1:** Validation preventing empty secondary method display
- **Story 14.3 M1:** Registry error test ensuring proper error wrapping
- 10 total fixes across 5 stories

### 4. Consistent Test Patterns
- Table-driven tests throughout
- Reusable helpers like `createResultWithTimestamp()`
- All tests follow standard Go patterns

### 5. Existing Patterns Reused
- Story 14.4 used existing `styles.WarningStyle` and `emoji.Warning()`
- No reinventing the wheel
- Consistent user experience

---

## What Didn't Go Well

### 1. Integration Stories Had Most Fixes
- Story 14.5 (TUI integration): 4 fixes
- Story 14.2 (cross-layer timestamps): 3 fixes
- Pure domain stories (14.3, 14.4): 0-1 fixes each
- **Pattern:** Stories crossing multiple layers accumulate more edge cases

### 2. No Integration Tests in CI
- Carried forward from Epic 15 retrospective
- Unit tests pass but end-to-end flow not verified
- Epic 15's detection bug showed this risk

### 3. Mock Proliferation
- Story 14.3 required updating mocks in 3 files:
  - `internal/shared/testhelpers/mock_detector.go`
  - `internal/adapters/cli/refresh_test.go`
  - `internal/adapters/tui/model_refresh_test.go`
- Adding interface methods creates maintenance burden

### 4. No Real-World Validation Step
- Epic marked done based on tests passing
- Epic 15's retrospective showed this can miss production issues
- Need dogfooding step before closing epics

---

## Code Review Fix Summary

| Story | High | Medium | Low | Total |
|-------|------|--------|-----|-------|
| 14-1 | 0 | 2 | 0 | 2 |
| 14-2 | 0 | 3 | 0 | 3 |
| 14-3 | 0 | 1 | 0 | 1 |
| 14-4 | 0 | 0 | 0 | 0 |
| 14-5 | 1 | 3 | 0 | 4 |
| **Total** | **1** | **9** | **0** | **10** |

### Notable Fixes

| Story | Severity | Issue | Fix |
|-------|----------|-------|-----|
| 14-5 | H1 | UTF-8 truncation using byte slicing | Use rune slicing for multi-byte safety |
| 14-5 | M1 | Empty secondary method could display | Added validation check |
| 14-3 | M1 | Registry error not tested | Added error propagation test |
| 14-2 | M1 | Test method chaining unclear | Improved test structure |

---

## Lessons Learned

1. **Integration stories need more scrutiny** - Stories crossing domain → service → adapter → TUI accumulate more edge cases. Budget extra review time.

2. **UTF-8 awareness matters in TUI** - Any string truncation in display code should use runes, not bytes. Document as anti-pattern.

3. **Unit test success ≠ feature works** - Epic 15's bug discovery reinforces need for integration tests in CI.

4. **Mock proliferation is a code smell** - When new interface methods require updating 3+ mock files, consider consolidation strategy.

5. **Incremental story structure worked well** - Each story independently testable and merged cleanly. Continue this pattern.

6. **Code review process is catching real bugs** - 10 fixes including 1 High severity. Don't skip reviews.

---

## Action Items

### Critical Path

| # | Action Item | Owner | Priority | Status |
|---|-------------|-------|----------|--------|
| C1 | **Verify CI runs integration tests** | Dev | HIGH | Carry-forward from Epic 15 |

### Process Improvements

| # | Action Item | Owner | Priority | Status |
|---|-------------|-------|----------|--------|
| P1 | Add linting rule or documented anti-pattern for byte-slicing strings in TUI code | Dev | MEDIUM | New |
| P2 | Consolidate mock implementations to reduce update burden | Dev | LOW | New |
| P3 | Add real-world validation step before marking epics done | SM | MEDIUM | New |

---

## Next Epic Preparation

### Epic 15: Sub-1-Minute Agent Detection

**Status:** Complete but has blocking bug (RETRO-15-001)

**Dependency Note:** Epic 14 (methodology detection) and Epic 15 (agent detection) are independent systems. No dependency issues.

### Epic 16: Progress Metrics & Stats View

**Status:** Blocked until Epic 15 detection bug is fixed

**Priority Order:**
1. Fix Epic 15 detection bug (RETRO-15-001)
2. Verify CI integration tests (C1)
3. Proceed to Epic 16

---

## Retrospective Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 5/5 (100%) |
| Stories Added Mid-Epic | 0 |
| Tests Added | +38 |
| Code Review Fixes | 10 (1 High, 9 Medium) |
| Previous Action Items Resolved | N/A (Epic 13 had none) |
| New Action Items | 4 (1 critical, 3 process) |
| Critical Issues Discovered | 0 |
| Epic Marked Done | Yes |

---

## Business Outcome

**Problem Solved:** Projects that switch methodologies (e.g., Speckit → BMAD) were incorrectly detected due to first-match-wins registry strategy.

**Solution Delivered:** Most-recent-artifact-wins selection with coexistence warning for ambiguous cases (<1 hour timestamp difference).

**User Impact:** Dashboard now correctly shows the methodology the user is currently using, not the one they used to use.

---

*Retrospective facilitated by Bob (Scrum Master)*
*Document generated: 2026-01-16*
